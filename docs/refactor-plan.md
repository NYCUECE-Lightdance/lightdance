# 開發與部署流程重構計畫

**日期:** 2025-08-14
**作者:** Gemini

## 摘要

本次重構旨在改善 LightDance 專案的開發與部署流程。我們將引入環境特定的 Docker Compose 設定檔，並更新相關的啟動腳本，以明確區分本地開發與生產部署環境，從而提高流程的穩定性、可攜性與可維護性。

## 動機與問題

目前的設定存在以下問題：
1.  **單一設定檔**: 所有環境（開發、生產）的服務都定義在同一個 `docker-compose.yml` 檔案中，容易造成混淆，也可能在開發時啟動不必要的服務。
2.  **環境依賴**: 本地開發腳本 (`start-dev.sh`) 過去曾在主機上執行 `npm` 指令，導致其運行結果依賴於本機環境的設定（如 Node.js 版本、權限），造成啟動失敗。
3.  **職責不清**: 開發與部署的界線模糊，特別是在資料庫連接方面，沒有明確的機制來切換本地與遠端資料庫。

##  proposed changes

為了解決上述問題，我們提出以下修改計畫：

### 1. 引入環境特定的 Docker Compose 檔案

我們將棄用原有的 `docker-compose.yml`，並建立兩個新的設定檔：

- **`docker-compose.dev.yml`**:
    - **用途**: 專供本地開發使用。
    - **包含服務**: `frontend-dev` (React 開發伺服器), `backend`, `mongo` (本地資料庫), `mongo-express` (資料庫管理工具)。
    - **特點**: 提供一個包含資料庫的、完整的、且支援熱修改的本地開發環境。

- **`docker-compose.prod.yml`**:
    - **用途**: 專供生產環境部署使用。
    - **包含服務**: `nginx` (生產級前端伺服器), `backend`。
    - **特點**: 不包含資料庫服務。後端服務將透過環境變數 (`.env.production`) 連接到指定的遠端資料庫。

### 2. 更新啟動腳本

- **`start-dev.sh`**:
    - 此腳本現在會明確使用 `docker-compose.dev.yml` (`docker compose -f docker-compose.dev.yml up`)。
    - 其唯一職責是啟動一個完全容器化的本地開發環境。

- **`run-deploy.sh`**:
    - 此腳本將被修改為使用 `docker-compose.prod.yml` (`docker compose -f docker-compose.prod.yml up`)。
    - 用於在伺服器上部署生產環境，或在本地模擬生產環境進行測試。

### 3. 環境變數管理

- **`.env.development`**: 用於定義本地開發環境的變數（例如，本地資料庫的帳號密碼）。
- **`.env.production`**: 新增此檔案（或類似名稱），用於儲存生產環境的敏感資訊，特別是**遠端資料庫的連接URI**。
- **`.gitignore`**: 我們會確保 `.env.production` 這類包含敏感資訊的檔案被添加到 `.gitignore` 中，避免其被上傳到版本控制系統。

### 4. 清理工作

- 舊的 `docker-compose.yml` 將被刪除，以避免混淆。

## 預期效益

- **職責分離**: 開發與生產環境的設定完全分離，更加清晰。
- **可攜性**: 整個開發環境都在 Docker 中，開發者只需安裝 Docker 即可開始工作，避免了「在我電腦上可以跑」的問題。
- **穩定性**: 生產部署將使用獨立、精簡的設定，更加穩定可靠。
- **可維護性**: 清晰的結構與中文註解讓未來的維護更加容易。
